name: Build X-OPT

on:
  push:
    branches: [ "main", "dev" ]
    tags:     [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build (Windows MSVC x64)
    runs-on: windows-latest

    env:
      BUILD_TYPE:               Release
      VCPKG_ROOT:               C:/vcpkg
      # Overrides the runner's built-in VS vcpkg path — critical fix
      VCPKG_INSTALLATION_ROOT:  C:/vcpkg

    steps:
      # ── 1. Checkout ─────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── 2. Setup MSVC ───────────────────────────────────────────────────────
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Add MSVC to PATH
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ── 3. Cache vcpkg packages ─────────────────────────────────────────────
      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: C:/vcpkg/installed
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-${{ runner.os }}-

      # ── 4. Clone + Bootstrap vcpkg at C:/vcpkg ─────────────────────────────
      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          if (Test-Path "C:/vcpkg/.git") {
            Write-Host "vcpkg already present, updating..."
            git -C C:/vcpkg pull --ff-only
          } else {
            Write-Host "Cloning vcpkg..."
            git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
          }
          & "C:/vcpkg/bootstrap-vcpkg.bat" -disableMetrics
          Write-Host "vcpkg bootstrapped at C:/vcpkg"
          & "C:/vcpkg/vcpkg.exe" version

      # ── 5. Inject builtin-baseline into vcpkg.json ─────────────────────────
      - name: Inject vcpkg baseline
        shell: pwsh
        run: |
          $baseline = git -C C:/vcpkg rev-parse HEAD
          Write-Host "vcpkg baseline: $baseline"
          $manifest = Get-Content vcpkg.json -Raw | ConvertFrom-Json
          $manifest | Add-Member -Force -NotePropertyName "builtin-baseline" -NotePropertyValue $baseline
          $manifest | ConvertTo-Json -Depth 10 | Set-Content vcpkg.json
          Write-Host "vcpkg.json updated:"
          Get-Content vcpkg.json

      # ── 6. Configure CMake ──────────────────────────────────────────────────
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DVCPKG_MANIFEST_MODE=ON `
            -DCMAKE_INSTALL_PREFIX=dist

      # ── 7. Build ────────────────────────────────────────────────────────────
      - name: Build
        shell: pwsh
        run: |
          cmake --build build --config Release --parallel 4

      # ── 8. Locate the .exe ──────────────────────────────────────────────────
      - name: Locate executable
        id: locate
        shell: pwsh
        run: |
          $bin = Get-ChildItem -Recurse -Filter "X-OPT.exe" build/ | Select-Object -First 1
          if ($null -eq $bin) {
            Write-Error "X-OPT.exe not found! Listing build output:"
            Get-ChildItem -Recurse build/ | Select-Object FullName
            exit 1
          }
          Write-Host "Found: $($bin.FullName)"
          echo "EXE_PATH=$($bin.FullName)" >> $env:GITHUB_OUTPUT

      # ── 9. Upload artifact ──────────────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: X-OPT-Windows-${{ github.sha }}
          path: ${{ steps.locate.outputs.EXE_PATH }}
          retention-days: 30

      # ── 10. GitHub Release on version tag ───────────────────────────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: X-OPT ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: ${{ steps.locate.outputs.EXE_PATH }}
          body: |
            ## X-OPT Engine ${{ github.ref_name }}
            - Boost Engine, Deep Clean, Game Launcher, Phonk Player
            - Run as Administrator on Windows 10/11 (64-bit)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
