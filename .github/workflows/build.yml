# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# X-OPT Engine â€” GitHub Actions Build Pipeline
# Compiles the release binary using MSVC + vcpkg + CMake on Windows
# Artifact: X-OPT.exe (uploaded to GitHub Releases on tag push)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Build X-OPT

on:
  push:
    branches: [ "main", "dev" ]
    tags:     [ "v*.*.*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:        # Allow manual trigger from GitHub UI

jobs:
  build:
    name: Build (Windows MSVC x64)
    runs-on: windows-latest

    env:
      BUILD_TYPE:    Release
      VCPKG_ROOT:    C:/vcpkg
      BINARY_NAME:   X-OPT.exe

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ 2. Setup MSVC developer environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Add MSVC to PATH
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # â”€â”€ 3. Cache vcpkg binary cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg
            C:/Users/runneradmin/AppData/Local/vcpkg/archives
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      # â”€â”€ 4. Bootstrap vcpkg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Bootstrap vcpkg
        run: |
          # Always clone to C:/vcpkg â€” avoids collision with VS built-in vcpkg
          if (Test-Path "C:/vcpkg/.git") {
            Write-Host "vcpkg already cloned, pulling latest..."
            git -C C:/vcpkg pull
          } else {
            Write-Host "Cloning vcpkg to C:/vcpkg..."
            git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
          }
          Write-Host "Bootstrapping vcpkg..."
          & "C:/vcpkg/bootstrap-vcpkg.bat" -disableMetrics
          Write-Host "vcpkg ready at C:/vcpkg"
        shell: pwsh

      # â”€â”€ 5. Configure CMake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure CMake
        run: |
          cmake -B build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_INSTALL_PREFIX=dist
        shell: pwsh

      # â”€â”€ 6. Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build
        run: |
          cmake --build build `
            --config ${{ env.BUILD_TYPE }} `
            --parallel ${{ steps.cpu-count.outputs.count }}
        shell: pwsh

      # â”€â”€ 7. Locate binary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Locate executable
        id: locate
        run: |
          $bin = Get-ChildItem -Recurse -Filter "X-OPT.exe" build/ | Select-Object -First 1
          if ($null -eq $bin) { Write-Error "X-OPT.exe not found!"; exit 1 }
          echo "EXE_PATH=$($bin.FullName)" >> $env:GITHUB_OUTPUT
          echo "Found: $($bin.FullName)"
        shell: pwsh

      # â”€â”€ 8. Upload build artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: X-OPT-${{ runner.os }}-${{ github.sha }}
          path: ${{ steps.locate.outputs.EXE_PATH }}
          retention-days: 30

      # â”€â”€ 9. Create GitHub Release on version tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: X-OPT ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: ${{ steps.locate.outputs.EXE_PATH }}
          body: |
            ## X-OPT Engine ${{ github.ref_name }}

            ### ğŸš€ What's inside
            - **Boost Engine** â€” High Performance power, 1ms timer, Game Mode, Network optimisation
            - **Deep Clean** â€” %TEMP%, Windows\\Temp, Prefetch, DNS cache
            - **Game Launcher** â€” Launch any .exe with HIGH priority class
            - **Phonk Player** â€” Background music with animated visualiser

            ### âš ï¸ Requirements
            - Windows 10 / 11 (64-bit)
            - Run as **Administrator** for full effect
            - DirectX 11 capable GPU (virtually all modern PCs)

            ### ğŸ“¦ Installation
            Just download `X-OPT.exe` and run it. No installer needed.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
